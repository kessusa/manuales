import functools
import operator
from django.db.models import Q


def build_workload_map(all_ips):
    if not all_ips:
        return {}

    # Limpiar m√°scaras de red
    clean_ips = {ip.split('/')[0] for ip in all_ips}

    q = functools.reduce(
        operator.or_,
        [Q(interfaces__ip_address__icontains=ip) for ip in clean_ips]
    )
    workloads = Workload.objects.filter(q).prefetch_related('interfaces', 'labels').distinct()

    workload_map = {}
    for ip in all_ips:
        clean_ip = ip.split('/')[0]
        workload_map[ip] = next(
            (w for w in workloads
             if any(clean_ip in iface.ip_address for iface in w.interfaces.all())),
            None
        )

    return workload_map
